<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - AgroWeather</title>
  <style>
  
    .badge-online {
  background: rgba(34, 197, 94, 0.2);
  color: var(--primary);
  animation: pulse 2s ease-in-out infinite;
}

.badge-offline {
  background: rgba(148, 163, 184, 0.2);
  color: var(--text-muted);
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.6;
  }
}
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0f1e;
      --bg-light: #0f172a;
      --panel: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --primary: #22c55e;
      --primary-dark: #16a34a;
      --primary-light: #4ade80;
      --border: #334155;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --shadow: rgba(0, 0, 0, 0.3);
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0a0f1e 0%, #1e293b 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .screen.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Login Screen */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .auth-box {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px var(--shadow);
    }
    
    .auth-box h2 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }
    
    .auth-box p {
      color: var(--text-muted);
      margin-bottom: 2rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    button {
      padding: 14px 32px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: #0a1810;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
    }

    .btn-secondary {
      background: var(--panel);
      color: var(--text);
      border: 2px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--bg-light);
      border-color: var(--primary);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }
    
    .error-message {
      color: var(--danger);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    .success-message {
      color: var(--primary);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    /* Dashboard */
    .dashboard-header {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .welcome-text h2 {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 0.3rem;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px var(--shadow);
    }

    .card h3 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: var(--primary-light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .user-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .user-table th,
    .user-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .user-table th {
      background: var(--bg-light);
      font-weight: 600;
      color: var(--primary-light);
    }

    .user-table tr:hover {
      background: var(--bg-light);
    }

    .badge {
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge-admin {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .badge-user {
      background: rgba(59, 130, 246, 0.2);
      color: var(--info);
    }

    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .user-table {
        font-size: 0.85rem;
      }

      .user-table th,
      .user-table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>

  <!-- Admin Login Screen -->
  <div id="adminLoginScreen" class="screen active">
    <div class="auth-container">
      <div class="auth-box">
        <div style="text-align: center; margin-bottom: 2rem;">
          <div style="font-size: 3.5rem; margin-bottom: 1rem;">üõ°Ô∏è</div>
          <h2>Admin Login</h2>
          <p>Access the admin dashboard</p>
        </div>
        
        <form id="adminLoginForm" onsubmit="handleAdminLogin(event)">
          <div class="form-group">
            <label>üë§ Username</label>
            <input type="text" id="admin_username" required placeholder="admin">
          </div>
          
          <div class="form-group">
            <label>üîí Password</label>
            <input type="password" id="admin_password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          
          <div id="adminLoginError" class="error-message"></div>
          
          <div class="form-group">
            <button type="submit" class="btn-primary">
              Log In as Admin
            </button>
          </div>
        </form>
        
        <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
          <p style="color: var(--text-muted); font-size: 0.9rem;">Regular user?</p>
          <a href="index.html" style="color: var(--primary); text-decoration: none; font-weight: 600;">Go to Main Site</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="screen">
    <div class="container">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="welcome-text">
          <h2>üõ°Ô∏è Admin Dashboard</h2>
          <p style="color: var(--text-muted);">Manage users and send notifications</p>
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="btn-secondary" onclick="refreshAdminData()">üîÑ Refresh</button>
          <button class="btn-danger" onclick="handleAdminLogout()">üö™ Log Out</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalNotifications">0</div>
          <div class="stat-label">Notifications Sent</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeUsers">0</div>
          <div class="stat-label">Active Today</div>
        </div>
      </div>

      <!-- Send Notification Section -->
      <div class="card">
        <h3>üì§ Send Notification to All Users</h3>
        
        <!-- Demo Buttons -->
        <div style="margin-bottom: 2rem;">
          <h4 style="margin-bottom: 1rem; font-size: 1rem; color: var(--text-muted);">Quick Demo Notifications</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <button class="btn-secondary" onclick="sendDemoNotification('typhoon')">
              üå™Ô∏è Typhoon Alert
            </button>
            <button class="btn-secondary" onclick="sendDemoNotification('rainfall')">
              üåßÔ∏è Heavy Rain
            </button>
            <button class="btn-secondary" onclick="sendDemoNotification('heatwave')">
              üî• Heat Wave
            </button>
            <button class="btn-secondary" onclick="sendDemoNotification('harvest')">
              ‚úÖ Good Harvest Day
            </button>
          </div>
        </div>

       <!-- Replace your existing form in admin.html -->
<!-- Replace your existing form in admin.html -->
<form id="notificationForm" onsubmit="sendNotification(event)">
  <div class="form-group">
    <label>üìù Notification Title</label>
    <input 
      type="text" 
      id="notifTitle" 
      required 
      minlength="3" 
      maxlength="100" 
      placeholder="e.g., Weather Alert"
      oninput="updateCharCount('notifTitle', 'titleCount', 100)"
    >
    <small style="color: var(--text-muted); font-size: 0.85rem;">
      <span id="titleCount">0</span>/100 characters (min 3)
    </small>
  </div>
  
  <div class="form-group">
    <label>üí¨ Message</label>
    <textarea 
      id="notifMessage" 
      required 
      minlength="10" 
      maxlength="500" 
      rows="4" 
      placeholder="Type your message here..."
      oninput="updateCharCount('notifMessage', 'messageCount', 500)"
    ></textarea>
    <small style="color: var(--text-muted); font-size: 0.85rem;">
      <span id="messageCount">0</span>/500 characters (min 10)
    </small>
  </div>
  
  <div class="form-group">
    <label>üè∑Ô∏è Type</label>
    <select id="notifType" required>
      <option value="info">Info</option>
      <option value="warning">Warning</option>
      <option value="alert">Alert</option>
      <option value="success">Success</option>
    </select>
  </div>
  
  <div id="notifSuccess" class="success-message" style="display: none;"></div>
  <div id="notifError" class="error-message" style="display: none;"></div>
  
  <button type="submit" class="btn-primary">
    Send to All Farmers
  </button>
</form>
      </div>

      <!-- User Management -->
      <div class="card">
        <h3>üë• Registered Users</h3>
        <div id="usersTableContainer">
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
            <p>Loading users...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Auto-detect API base
    const API_BASE = (() => {
      const hostname = window.location.hostname;
      return `http://${hostname}:8000/api`;
    })();

    let authToken = null;
    let currentAdmin = null;

   // Character counter for form validation
function updateCharCount(inputId, counterId, maxLength) {
  const input = document.getElementById(inputId);
  const counter = document.getElementById(counterId);
  
  if (input && counter) {
    const length = input.value.length;
    counter.textContent = length;
    
    // Change color based on validity
    if (inputId === 'notifTitle') {
      if (length < 3 || length > maxLength) {
        counter.style.color = 'var(--danger)';
      } else {
        counter.style.color = 'var(--primary)';
      }
    } else if (inputId === 'notifMessage') {
      if (length < 10 || length > maxLength) {
        counter.style.color = 'var(--danger)';
      } else {
        counter.style.color = 'var(--primary)';
      }
    }
  }
}


    // Check if already logged in
    window.addEventListener('DOMContentLoaded', () => {
      const savedToken = localStorage.getItem('adminAuthToken');
      const savedAdmin = localStorage.getItem('currentAdmin');
      
      if (savedToken && savedAdmin) {
        authToken = savedToken;
        currentAdmin = JSON.parse(savedAdmin);
        showAdminDashboard();
      }
    });

    // Admin Login
    async function handleAdminLogin(e) {
      e.preventDefault();
      const errorEl = document.getElementById('adminLoginError');
      errorEl.textContent = '';

      const data = {
        username: document.getElementById('admin_username').value,
        password: document.getElementById('admin_password').value
      };

      try {
        const response = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Login failed');
        }

        const result = await response.json();
        
        // Check if user is admin
        if (!result.user.is_admin) {
          throw new Error('Access denied. Admin privileges required.');
        }

        authToken = result.token;
        currentAdmin = result.user;
        localStorage.setItem('adminAuthToken', authToken);
        localStorage.setItem('currentAdmin', JSON.stringify(currentAdmin));
        
        showAdminDashboard();
      } catch (error) {
        errorEl.textContent = error.message;
      }
    }

    // Admin Logout
    async function handleAdminLogout() {
      try {
        await fetch(`${API_BASE}/logout`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
      } catch (error) {
        console.error('Logout error:', error);
      }
      
      authToken = null;
      currentAdmin = null;
      localStorage.removeItem('adminAuthToken');
      localStorage.removeItem('currentAdmin');
      showScreen('adminLoginScreen');
    }

    // Show Dashboard
    function showAdminDashboard() {
      showScreen('adminDashboard');
      refreshAdminData();
    }

    // Refresh Admin Data
    async function refreshAdminData() {
      await Promise.all([
        loadStats(),
        loadUsers()
      ]);
    }

    // Load Stats
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/admin/stats`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (!response.ok) throw new Error('Failed to load stats');

        const stats = await response.json();
        document.getElementById('totalUsers').textContent = stats.total_users || 0;
        document.getElementById('totalNotifications').textContent = stats.total_notifications || 0;
        document.getElementById('activeUsers').textContent = stats.active_users || 0;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
// Load Users with Online Status
// Load Users with Online Status
async function loadUsers() {
  const container = document.getElementById('usersTableContainer');
  
  try {
    const response = await fetch(`${API_BASE}/admin/users`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });

    if (!response.ok) throw new Error('Failed to load users');

    const users = await response.json();
    
    if (users.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No users registered yet</p>';
      return;
    }

    let html = `
      <table class="user-table">
        <thead>
          <tr>
            <th>Status</th>
            <th>Name</th>
            <th>Username</th>
            <th>Location</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Role</th>
            <th>Registered</th>
          </tr>
        </thead>
        <tbody>
    `;

    users.forEach(user => {
      const date = new Date(user.created_at).toLocaleDateString();
      const badge = user.is_admin ? 
        '<span class="badge badge-admin">ADMIN</span>' : 
        '<span class="badge badge-user">USER</span>';
      
      // Online/Offline status
      const statusBadge = user.is_online ? 
        '<span class="badge badge-online">üü¢ Online</span>' : 
        '<span class="badge badge-offline">‚ö´ Offline</span>';
      
      html += `
        <tr>
          <td>${statusBadge}</td>
          <td>${user.name}</td>
          <td>${user.username}</td>
          <td>${user.location}</td>
          <td>${user.age}</td>
          <td>${user.gender}</td>
          <td>${badge}</td>
          <td>${date}</td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;

  } catch (error) {
    console.error('Error loading users:', error);
    container.innerHTML = `<p class="error-message">Error: ${error.message}</p>`;
  }
}

// Auto-refresh every 30 seconds to update online status
setInterval(() => {
  if (document.querySelector('#adminDashboard.active')) {
    loadUsers();
  }
}, 30000);

// Auto-refresh every 30 seconds to update online status
setInterval(() => {
  if (document.querySelector('#adminDashboard.active')) {
    loadUsers();
  }
}, 30000);
    // Send Demo Notification
    async function sendDemoNotification(type) {
      const templates = {
        'typhoon': {
          title: 'Typhoon Warning',
          message: 'A typhoon is approaching your area. Secure your crops and livestock immediately.',
          type: 'alert'
        },
        'rainfall': {
          title: 'Heavy Rainfall Alert',
          message: 'Heavy rainfall expected in the next 24 hours. Ensure proper drainage in your fields.',
          type: 'warning'
        },
        'heatwave': {
          title: 'Heat Wave Advisory',
          message: 'Extreme heat expected. Increase irrigation and provide shade for livestock.',
          type: 'warning'
        },
        'harvest': {
          title: 'Optimal Harvest Conditions',
          message: 'Weather conditions are ideal for harvesting. Plan your harvest activities accordingly.',
          type: 'success'
        }
      };

      const template = templates[type];
      if (!template) return;

      try {
        const response = await fetch(`${API_BASE}/notifications/broadcast`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(template)
        });

        if (!response.ok) throw new Error('Failed to send notification');

        alert('‚úÖ Notification sent to all users!');
        refreshAdminData();
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    // Send Custom Notification
// Send Custom Notification
async function sendNotification(e) {
  e.preventDefault();
  
  const successEl = document.getElementById('notifSuccess');
  const errorEl = document.getElementById('notifError');
  successEl.style.display = 'none';
  errorEl.style.display = 'none';

  const data = {
    title: document.getElementById('notifTitle').value.trim(),
    message: document.getElementById('notifMessage').value.trim(),
    type: document.getElementById('notifType').value
  };

  // Validation
  if (!data.title || data.title.length < 3) {
    errorEl.textContent = '‚ùå Title must be at least 3 characters';
    errorEl.style.display = 'block';
    return;
  }

  if (!data.message || data.message.length < 10) {
    errorEl.textContent = '‚ùå Message must be at least 10 characters';
    errorEl.style.display = 'block';
    return;
  }

  console.log('Sending notification:', data); // Debug log

  try {
    const response = await fetch(`${API_BASE}/notifications/broadcast`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });

    console.log('Response status:', response.status); // Debug log

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
      console.error('Error response:', errorData); // Debug log
      throw new Error(errorData.detail || 'Failed to send notification');
    }

    const result = await response.json();
    console.log('Success response:', result); // Debug log

    successEl.textContent = `‚úÖ Notification sent successfully to ${result.recipients || 'all'} users!`;
    successEl.style.display = 'block';
    
    // Clear form
    document.getElementById('notificationForm').reset();
    
    // Refresh stats
    refreshAdminData();

  } catch (error) {
    console.error('Full error:', error); // Debug log
    errorEl.textContent = '‚ùå Error: ' + error.message;
    errorEl.style.display = 'block';
  }
}

    // Screen Management
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function updateCharCount(inputId, counterId, maxLength) {
      const input = document.getElementById(inputId);
      const counter = document.getElementById(counterId);
      
      if (input && counter) {
        const length = input.value.length;
        counter.textContent = length;
        
        // Change color based on validity
        if (inputId === 'notifTitle') {
          if (length < 3 || length > maxLength) {
            counter.style.color = 'var(--danger)';
          } else {
            counter.style.color = 'var(--primary)';
          }
        } else if (inputId === 'notifMessage') {
          if (length < 10 || length > maxLength) {
            counter.style.color = 'var(--danger)';
          } else {
            counter.style.color = 'var(--primary)';
          }
        }
      }
    }
  </script>
</body>
</html>